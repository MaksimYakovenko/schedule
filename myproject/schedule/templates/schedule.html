{% load static %}
{% load dict_filters %}
{% load list_filters %}
<html lang="uk" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>–†–æ–∑–∫–ª–∞–¥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'schedule/css/schedule.css' %}" type="text/css" media="all" />
    <style>
        .delete-button {
            background-color: transparent;
            border: none;
            color: #e53935;
            cursor: pointer;
            font-size: 20px;
            padding: 6px;
            border-radius: 6px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            transform: scale(0.9)
        }

        .delete-button:hover {
            background-color: #ffe5e5;
            transform: scale(1.1);
        }

        .delete-button:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(229, 57, 53, 0.4);
        }
    </style>
</head>
<body>
    <h1>–†–æ–∑–∫–ª–∞–¥</h1>

    <form method="get" action="{% url 'schedule_view' %}">
    <label for="teacher">–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–ª–∞–¥–∞—á–∞:</label>
    <select name="teacher_id" id="teacher">
        <option value="">–í—Å—ñ –≤–∏–∫–ª–∞–¥–∞—á—ñ</option>
        {% for teacher in teachers %}
            <option value="{{ teacher.id }}" {% if teacher.id == selected_teacher_id %}selected{% endif %}>
                {{ teacher.full_name }}
            </option>
        {% endfor %}
    </select>

        <label for="course">–ö—É—Ä—Å:</label>
    <select name="course" id="course" onchange="this.form.submit()">
        <option value="">–í—Å—ñ –∫—É—Ä—Å–∏</option>
        <option value="1" {% if selected_course == 1 %}selected{% endif %}>1 –∫—É—Ä—Å</option>
        <option value="2" {% if selected_course == 2 %}selected{% endif %}>2 –∫—É—Ä—Å</option>
        <option value="3" {% if selected_course == 3 %}selected{% endif %}>3 –∫—É—Ä—Å</option>
        <option value="4" {% if selected_course == 4 %}selected{% endif %}>4 –∫—É—Ä—Å</option>
        <option value="m1" {% if selected_course == m1 %}selected{% endif %}>1 –∫—É—Ä—Å –º–∞–≥.</option>
        <option value="m2" {% if selected_course == m2 %}selected{% endif %}>2 –∫—É—Ä—Å –º–∞–≥.</option>
    </select>

    <label for="semester">–°–µ–º–µ—Å—Ç—Ä:</label>
    <select name="semester_id" id="semester">
        <option value="">–£—Å—ñ —Å–µ–º–µ—Å—Ç—Ä–∏</option>
        {% for semester in semesters %}
            <option value="{{ semester.id }}" {% if semester.id == selected_semester_id %}selected{% endif %}>
                {{ semester.year }} / {{ semester.number }} —Å–µ–º–µ—Å—Ç—Ä
            </option>
        {% endfor %}
    </select>

    <button type="submit">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
</form>

<form method="post" action="{% url 'generate_schedule' %}">
    {% csrf_token %}
    <input type="hidden" name="semester_id" id="hiddenSemesterId" value="{{ selected_semester_id }}">
    <button type="submit" id="generateButton" disabled>–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const semesterSelect = document.getElementById('semester');
        const generateButton = document.getElementById('generateButton');
        const hiddenSemesterId = document.getElementById('hiddenSemesterId');

        function updateButtonState() {
            const selected = semesterSelect.value;
            generateButton.disabled = !selected;
            hiddenSemesterId.value = selected;
        }

        semesterSelect.addEventListener('change', updateButtonState);
        updateButtonState();
    });
</script>

    {% for course in sorted_course_keys %}
    <h2>{{ course }} –∫—É—Ä—Å</h2>
    {% with course_groups=groups_by_course|dict_get:course %}
    <table border="1">
        <thead>
            <tr>
                <th></th>
                {% for group in course_groups %}
                    <th>{{ group.name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for day in days_of_week %}
                <tr>
                    <td style="text-align: center; vertical-align: middle; transform: rotate(-0.25turn); white-space: nowrap;">
                        {{ day }}
                    </td>
                    {% for group in course_groups %}
                        <td>
                            {% with lesson_count=0 %}
                                {% for entry in schedule_entries %}
                                    {% if entry.group == group and entry.day_of_week == day %}
                                        {% with lesson_count=lesson_count|add:1 %}
                                            <div class="schedule-entry">
                                                <strong class="lesson-number">{{ entry.lesson_number }} –ø–∞—Ä–∞</strong>
                                                <span class="subject">{{ entry.lesson.subject.name }}</span>
                                                <span class="subject">{{ entry.lesson.lesson_type }}</span>
                                                <span class="teacher">{{ entry.lesson.teacher.position }} {{ entry.lesson.teacher.full_name }}</span>
                                                <span class="degree">{{ entry.lesson.teacher.degree }}</span>
                                                <span class="classroom">–∞—É–¥. {{ entry.classroom.name }}</span>
                                                 <form method="post" action="{% url 'delete_lesson' entry.lesson.id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="delete-button" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–∞—Ä—É?');" title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø–∞—Ä—É">üóëÔ∏è</button>
                                                </form>

                                            </div>
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                                {% if lesson_count < 1 %}
                                    <div class="no-lessons">–ù–µ–º–∞—î –∑–∞–Ω—è—Ç—å</div>
                                {% endif %}
                            {% endwith %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endwith %}
{% endfor %}

</body>
</html>
